# base node image
FROM node:20-bullseye-slim as base

# set for base and all layer that inherit from it
ENV NODE_ENV production

# pass down env variables
ARG SESSION_SECRET
ARG AGENCY_NAME
ARG MAPBOX_ACCESS_TOKEN
ARG GTFS_URL
ARG ADMIN_EMAIL
ARG ADMIN_PASSWORD
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG S3_BUCKET
ARG DATABASE_URL

ENV DATABASE_URL=${DATABASE_URL}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV AGENCY_NAME=${AGENCY_NAME}
ENV MAPBOX_ACCESS_TOKEN=${MAPBOX_ACCESS_TOKEN}
ENV GTFS_URL=${GTFS_URL}
ENV ADMIN_EMAIL=${ADMIN_EMAIL}
ENV ADMIN_PASSWORD=${ADMIN_PASSWORD}
ENV REPLICA_URL=s3://${S3_BUCKET}/data.db
ENV S3_BUCKET=${S3_BUCKET}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV PORT="8080"
ENV NODE_ENV="production"


ADD https://github.com/benbjohnson/litestream/releases/download/v0.3.8/litestream-v0.3.8-linux-amd64-static.tar.gz /tmp/litestream.tar.gz
RUN tar -C /usr/local/bin -xzf /tmp/litestream.tar.gz

RUN apt-get update && apt-get install -y openssl sqlite3 && npm i -g dotenv

ADD package.json .npmrc ./
RUN npm install --include=dev

ADD . .
RUN npm run build

RUN npm run generate
RUN npm run db:push

CMD [ "/scripts/run.sh" ]
RUN echo "#!/bin/sh\nset -x\nsqlite3 \$DATABASE_URL" > /usr/local/bin/database-cli && chmod +x /usr/local/bin/database-cli

ENTRYPOINT [ "./start.sh" ]
